name: Notify Feishu on Issues

on:
  issues:
    types: [opened, reopened, edited, labeled, closed, assigned]
  workflow_dispatch:
    inputs:
      title:
        description: "æ‰‹åŠ¨æµ‹è¯•æ ‡é¢˜"
        required: false
      url:
        description: "æ‰‹åŠ¨æµ‹è¯•é“¾æŽ¥"
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build Feishu payload (handles all actions & manual run)
        env:
          # è¿™äº›è¡¨è¾¾å¼ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶ç”¨ä½œå…œåº•å€¼
          FALLBACK_TITLE: ${{ inputs.title || 'Manual Test Issue' }}
          FALLBACK_URL:   ${{ inputs.url || format('{0}/{1}', github.server_url, github.repository) }}
          ACTOR:          ${{ github.actor }}
        run: |
          # ä»Žäº‹ä»¶ JSON ä¸­æå–å­—æ®µï¼ˆissues äº‹ä»¶æœ‰ .issueï¼›æ‰‹åŠ¨è§¦å‘æ—¶å¯èƒ½æ²¡æœ‰ï¼‰
          ACTION=$(jq -r '.action // "workflow_dispatch"' "$GITHUB_EVENT_PATH")
          TITLE=$(jq -r '.issue.title // empty' "$GITHUB_EVENT_PATH")
          URL=$(jq -r '.issue.html_url // empty' "$GITHUB_EVENT_PATH")
          NUMBER=$(jq -r '.issue.number // empty' "$GITHUB_EVENT_PATH")
          AUTHOR=$(jq -r '.issue.user.login // empty' "$GITHUB_EVENT_PATH")
          STATE=$(jq -r '.issue.state // empty' "$GITHUB_EVENT_PATH")
          LABELS=$(jq -r '[.issue.labels[]?.name] | join(", ")' "$GITHUB_EVENT_PATH")
          ASSIGNEE=$(jq -r '.assignee.login // empty' "$GITHUB_EVENT_PATH")   # issues: assigned æ—¶æœ‰
          SINGLE_LABEL=$(jq -r '.label.name // empty' "$GITHUB_EVENT_PATH")    # issues: labeled æ—¶æœ‰

          # å…œåº•ï¼ˆæ‰‹åŠ¨è§¦å‘æˆ–å­—æ®µç¼ºå¤±æ—¶ï¼‰
          TITLE=${TITLE:-"$FALLBACK_TITLE"}
          URL=${URL:-"$FALLBACK_URL"}
          NUMBER=${NUMBER:-"N/A"}
          AUTHOR=${AUTHOR:-"$ACTOR"}
          STATE=${STATE:-"open"}

          # åŸºç¡€å¡ç‰‡
          cat > payload.json <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": {
                "title": { "tag": "plain_text", "content": "ðŸ™ GitHub Issue ${ACTION}: #${NUMBER}" }
              },
              "elements": [
                { "tag": "div", "text": { "tag": "lark_md", "content": "**${TITLE}**" } },
                { "tag": "div", "text": { "tag": "lark_md", "content": "ä½œè€…ï¼š${AUTHOR}  çŠ¶æ€ï¼š${STATE}" } },
                { "tag": "div", "text": { "tag": "lark_md", "content": "ðŸ‘‰ [åœ¨ GitHub æ‰“å¼€](${URL})" } }
              ]
            }
          }
          EOF

          # å¦‚æœ‰â€œå…¨éƒ¨æ ‡ç­¾â€ï¼Œè¿½åŠ ä¸€è¡Œ
          if [ -n "$LABELS" ]; then
            jq --arg labels "$LABELS" \
               '.card.elements += [{"tag":"div","text":{"tag":"lark_md","content":("æ ‡ç­¾ï¼š" + $labels)}}]' \
               payload.json > tmp && mv tmp payload.json
          fi

          # å¦‚æžœæ˜¯ labeled åŠ¨ä½œï¼Œè¿½åŠ â€œæ–°å¢žæ ‡ç­¾ï¼šXâ€
          if [ "$ACTION" = "labeled" ] && [ -n "$SINGLE_LABEL" ]; then
            jq --arg lab "$SINGLE_LABEL" \
               '.card.elements += [{"tag":"div","text":{"tag":"lark_md","content":("æ–°å¢žæ ‡ç­¾ï¼š" + $lab)}}]' \
               payload.json > tmp && mv tmp payload.json
          fi

          # å¦‚æžœæ˜¯ assigned åŠ¨ä½œï¼Œè¿½åŠ â€œæŒ‡æ´¾ç»™ï¼š@userâ€
          if [ "$ACTION" = "assigned" ] && [ -n "$ASSIGNEE" ]; then
            jq --arg a "$ASSIGNEE" \
               '.card.elements += [{"tag":"div","text":{"tag":"lark_md","content":("æŒ‡æ´¾ç»™ï¼š" + $a)}}]' \
               payload.json > tmp && mv tmp payload.json
          fi

          echo "=== Payload to Feishu ==="
          cat payload.json

      - name: Send to Feishu
        env:
          WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          curl -s -w "\nhttp_code=%{http_code}\n" -X POST -H 'Content-Type: application/json' \
            -d @payload.json "$WEBHOOK" | tee response.log
